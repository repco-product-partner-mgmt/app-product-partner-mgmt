<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products and Partnership Management</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Azure AD Authentication - MSAL.js (using jsdelivr CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@3.10.0/lib/msal-browser.min.js"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --secondary-color: #64748b;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --status-green: #22c55e;
            --status-yellow: #eab308;
            --status-red: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--bg-white);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .nav {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 0.625rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.2s;
            position: relative;
        }

        .nav-btn:hover {
            background: var(--bg-light);
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--status-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Card Styles */
        .card {
            background: var(--bg-white);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            background: var(--bg-white);
            z-index: 10;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 1.5rem;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        /* Alert */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .alert.show {
            display: block;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        select, input, textarea {
            padding: 0.625rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            background: var(--bg-white);
            color: var(--text-primary);
            font-family: inherit;
        }

        select {
            min-width: 200px;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: var(--status-green);
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-danger {
            background: var(--status-red);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 0.375rem 0.875rem;
            font-size: 0.875rem;
        }

        /* Map View */
        #map {
            width: 100%;
            height: 600px;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
        }

        .map-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        /* Dashboard Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--bg-white);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .summary-card-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .summary-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Status Legend */
        .status-legend {
            display: flex;
            gap: 2rem;
            padding: 1rem 1.5rem;
            background: var(--bg-white);
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 0.25rem;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: var(--bg-light);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .data-table th {
            padding: 1rem;
            text-align: left;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            background: var(--bg-light);
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tr:hover {
            background: var(--bg-light);
        }

        .status-indicators {
            display: flex;
            gap: 0.375rem;
            flex-wrap: wrap;
        }

        .status-dot {
            width: 20px;
            height: 20px;
            border-radius: 0.25rem;
            cursor: help;
            position: relative;
        }

        .status-dot:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem;
            background: var(--text-primary);
            color: white;
            font-size: 0.75rem;
            white-space: nowrap;
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
            z-index: 1000;
        }

        .status-green { background: var(--status-green); }
        .status-yellow { background: var(--status-yellow); }
        .status-red { background: var(--status-red); }

        .progress-bar {
            width: 100px;
            height: 8px;
            background: var(--border-color);
            border-radius: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s;
        }

        /* Portfolio View */
        .portfolio-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        .portfolio-column {
            min-width: 280px;
            background: var(--bg-light);
            border-radius: 0.75rem;
            padding: 1rem;
            max-height: calc(100vh - 350px);
            display: flex;
            flex-direction: column;
        }

        .portfolio-column-header {
            font-weight: 600;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: var(--bg-white);
            border-radius: 0.5rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .portfolio-column-body {
            overflow-y: auto;
            flex: 1;
        }

        .project-card {
            background: var(--bg-white);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .project-card-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .project-card-partner {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: var(--bg-white);
            border-radius: 0.75rem;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-white);
            z-index: 10;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
        }

        .modal-close:hover {
            background: var(--bg-light);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            position: sticky;
            bottom: 0;
            background: var(--bg-white);
            z-index: 10;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.625rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.95rem;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .form-row-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 1rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .status-select-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .kpi-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .kpi-item {
            padding: 0.75rem;
            background: var(--bg-light);
            border-radius: 0.5rem;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 0.75rem;
            align-items: end;
        }

        /* FTE Allocation Grid */
        .fte-grid {
            display: grid;
            grid-template-columns: 200px 150px repeat(12, 80px) auto;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }

        .fte-grid-header {
            position: sticky;
            top: 0;
            background: var(--bg-light);
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
            font-size: 0.875rem;
            z-index: 5;
        }

        .fte-input {
            width: 70px;
            padding: 0.375rem 0.5rem;
            text-align: center;
            font-size: 0.875rem;
        }

        /* Team Member Styles */
        .team-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            background: var(--primary-color);
            color: white;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin: 0.125rem;
        }

        /* Section Divider */
        .section-divider {
            border: 0;
            border-top: 2px solid var(--border-color);
            margin: 2rem 0;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Category Styles */
        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            margin: 0.25rem;
            color: white;
            font-weight: 500;
        }

        .category-checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .category-checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-white);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-checkbox-item:hover {
            box-shadow: var(--shadow-sm);
        }

        .category-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .category-color-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Category & Role Management */
        .category-list, .role-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .category-item, .role-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 0.5rem;
        }

        .category-color-picker, .role-color-picker {
            width: 50px;
            height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            cursor: pointer;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Data Management Styles */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            max-width: 400px;
        }

        /* Save Button Fixed Position */
        .save-button-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1500;
        }

        .btn-save {
            padding: 1rem 2rem;
            font-size: 1rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Info Box */
        .info-box {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            color: #1e40af;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .info-box strong {
            color: #1e3a8a;
        }

        /* Notification Item */
        .notification-item {
            padding: 1rem;
            border-left: 4px solid var(--status-yellow);
            background: var(--bg-light);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .notification-item.critical {
            border-left-color: var(--status-red);
            background: #fee2e2;
        }

        .notification-item.warning {
            border-left-color: var(--status-yellow);
            background: #fef3c7;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
        }

        /* Heatmap */
        .heatmap-container {
            overflow-x: auto;
            margin-bottom: 2rem;
        }

        .heatmap-table {
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .heatmap-table th,
        .heatmap-table td {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            text-align: center;
            min-width: 80px;
        }

        .heatmap-table th {
            background: var(--bg-light);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .heatmap-cell {
            cursor: help;
            transition: all 0.2s;
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .nav {
                width: 100%;
                justify-content: center;
            }

            .container {
                padding: 1rem;
            }

            .form-row,
            .form-row-3,
            .form-row-4 {
                grid-template-columns: 1fr;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }

            .fte-grid {
                grid-template-columns: 150px 100px repeat(12, 70px) auto;
            }

            .save-button-container {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
            }

            .btn-save {
                width: 100%;
                justify-content: center;
            }
        }

        /* ========== LOGIN PAGE STYLES ========== */
        .login-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
        }

        .login-page.hidden {
            display: none;
        }

        .login-container {
            background: var(--bg-white);
            padding: 3rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            text-align: center;
            max-width: 420px;
            width: 90%;
        }

        .login-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 2rem;
        }

        .login-title {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .btn-login {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
            background: #2f2f2f;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-login:hover {
            background: #1a1a1a;
        }

        .microsoft-icon {
            width: 21px;
            height: 21px;
        }

        .login-loading {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .login-loading.active {
            display: flex;
        }

        .login-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* User Section in Header */
        .user-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding-left: 1rem;
            border-left: 1px solid var(--border-color);
            margin-left: 1rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .user-email {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .btn-logout {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: var(--status-red);
            border-color: var(--status-red);
            color: white;
        }

        @media (max-width: 768px) {
            .user-section {
                width: 100%;
                justify-content: center;
                border-left: none;
                border-top: 1px solid var(--border-color);
                padding-left: 0;
                padding-top: 1rem;
                margin-left: 0;
                margin-top: 1rem;
            }

            .user-info {
                align-items: center;
            }
        }

        /* Main App Hidden State */
        .main-app.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- ========== LOGIN PAGE ========== -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-logo">üè¢ Product & Partnership Management</div>
            <h2 class="login-title">Sign in to continue</h2>
            <p class="login-subtitle">Use your organizational Microsoft account</p>

            <div id="loginButton">
                <button class="btn-login" onclick="login()">
                    <svg class="microsoft-icon" viewBox="0 0 21 21">
                        <rect x="1" y="1" width="9" height="9" fill="#f25022"/>
                        <rect x="11" y="1" width="9" height="9" fill="#7fba00"/>
                        <rect x="1" y="11" width="9" height="9" fill="#00a4ef"/>
                        <rect x="11" y="11" width="9" height="9" fill="#ffb900"/>
                    </svg>
                    Sign in with Microsoft
                </button>
            </div>

            <div id="loginLoading" class="login-loading">
                <div class="login-spinner"></div>
                <span>Signing in...</span>
            </div>
        </div>
    </div>

    <!-- ========== MAIN APPLICATION ========== -->
    <div id="mainApp" class="main-app hidden">

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">üè¢ Product & Partnership Management</div>
            <nav class="nav">
                <button class="nav-btn active" onclick="showView('map')">Map</button>
                <button class="nav-btn" onclick="showView('dashboard')">Dashboard</button>
                <button class="nav-btn" onclick="showView('portfolio')">Portfolio</button>
                <button class="nav-btn" onclick="showView('resources')">Resources</button>
                <button class="nav-btn" onclick="showView('notifications')" id="notificationBtn">
                    Notifications
                    <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                </button>
                <button class="nav-btn" onclick="showView('managePartners')">Partners</button>
                <button class="nav-btn" onclick="showView('manageProjects')">Projects</button>
                <button class="nav-btn" onclick="showView('manageMembers')">Members</button>
                <button class="nav-btn" onclick="showView('manageRoles')">Roles</button>
                <button class="nav-btn" onclick="showView('manageCategories')">Categories</button>
            </nav>

            <!-- User Section -->
            <div class="user-section" id="userSection">
                <div class="user-info">
                    <span class="user-name" id="userName">-</span>
                    <span class="user-email" id="userEmail">-</span>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Alerts -->
        <div id="successAlert" class="alert success"></div>
        <div id="errorAlert" class="alert error"></div>
        <div id="warningAlert" class="alert warning"></div>

        <!-- Map View -->
        <div id="mapView" class="view active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Partner Locations</h2>
                </div>
                <div class="card-body">
                    <div class="map-controls">
                        <div class="filter-group">
                            <label class="filter-label">Filter by Category</label>
                            <select id="mapCategoryFilter" onchange="filterMapMarkers()">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="fitMapToMarkers()">Zoom to Fit All</button>
                    </div>
                    <div id="map"></div>
                </div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="view">
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-card-title">Total Projects</div>
                    <div class="summary-card-value" id="totalProjects">0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-title">Active Partners</div>
                    <div class="summary-card-value" id="totalPartners">0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-title">Average Progress</div>
                    <div class="summary-card-value" id="avgProgress">0%</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-title">Critical Issues</div>
                    <div class="summary-card-value" id="criticalIssues" style="color: var(--status-red);">0</div>
                </div>
            </div>

            <div class="status-legend">
                <div class="legend-item">
                    <div class="legend-color status-green"></div>
                    <span>Green - Good</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color status-yellow"></div>
                    <span>Yellow - Caution</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color status-red"></div>
                    <span>Red - Critical</span>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">Partner</label>
                            <select id="dashboardPartnerFilter" onchange="filterDashboard()">
                                <option value="">All Partners</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Category</label>
                            <select id="dashboardCategoryFilter" onchange="filterDashboard()">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Phase</label>
                            <select id="dashboardPhaseFilter" onchange="filterDashboard()">
                                <option value="">All Phases</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Status Color</label>
                            <select id="dashboardStatusFilter" onchange="filterDashboard()">
                                <option value="">All Statuses</option>
                                <option value="Red">Red (Critical)</option>
                                <option value="Yellow">Yellow (Caution)</option>
                                <option value="Green">Green (Good)</option>
                            </select>
                        </div>
                        <div class="filter-group" style="justify-content: flex-end;">
                            <label class="filter-label">&nbsp;</label>
                            <button class="btn btn-secondary" onclick="resetDashboardFilters()">Reset</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h3 class="card-title">Projects</h3>
                    <button class="btn btn-secondary btn-sm" onclick="exportProjectsCSV()">üìä Export CSV</button>
                </div>
                <div class="card-body">
                    <div id="projectTableContainer"></div>
                </div>
            </div>
        </div>

        <!-- Portfolio View -->
        <div id="portfolioView" class="view">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Project Portfolio by Phase</h2>
                </div>
                <div class="card-body">
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">Partner</label>
                            <select id="portfolioPartnerFilter" onchange="filterPortfolio()">
                                <option value="">All Partners</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Category</label>
                            <select id="portfolioCategoryFilter" onchange="filterPortfolio()">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Status Color</label>
                            <select id="portfolioStatusFilter" onchange="filterPortfolio()">
                                <option value="">All Statuses</option>
                                <option value="Red">Red (Critical)</option>
                                <option value="Yellow">Yellow (Caution)</option>
                                <option value="Green">Green (Good)</option>
                            </select>
                        </div>
                        <div class="filter-group" style="justify-content: flex-end;">
                            <label class="filter-label">&nbsp;</label>
                            <button class="btn btn-secondary" onclick="resetPortfolioFilters()">Reset</button>
                        </div>
                    </div>
                    <div id="portfolioBoard" class="portfolio-board"></div>
                </div>
            </div>
        </div>

        <!-- Resources View -->
        <div id="resourcesView" class="view">
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h2 class="card-title">Role Workload Heatmap (Next 12 Months)</h2>
                    <div>
                        <label style="font-size: 0.875rem; margin-right: 0.5rem;">Max FTE:</label>
                        <input type="number" id="maxFTE" value="1.5" step="0.1" min="0.5" max="5" 
                               style="width: 80px;" onchange="updateHeatmap()">
                    </div>
                </div>
                <div class="card-body">
                    <div class="heatmap-container" id="heatmapContainer"></div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h2 class="card-title">Monthly Workload Trend by Role</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="roleWorkloadChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h2 class="card-title">Role-Specific Workload</h2>
                    <select id="roleFilterChart" onchange="updateRoleSpecificChart()">
                        <option value="">Select Role</option>
                    </select>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="roleSpecificChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Individual Member Workload</h2>
                    <select id="memberFilterChart" onchange="updateMemberWorkloadChart()">
                        <option value="">Select Member</option>
                    </select>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="memberWorkloadChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications View -->
        <div id="notificationsView" class="view">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Contract & Agreement Notifications</h2>
                    <div>
                        <label style="font-size: 0.875rem; margin-right: 0.5rem;">Warning Days:</label>
                        <input type="number" id="warningDays" value="90" min="1" max="365" 
                               style="width: 80px;" onchange="updateNotifications()">
                    </div>
                </div>
                <div class="card-body">
                    <div id="notificationsList"></div>
                </div>
            </div>
        </div>

        <!-- Manage Partners View -->
        <div id="managePartnersView" class="view">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Manage Partners</h2>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="openPartnerModal()">‚ûï Add</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('uploadPartnersFile').click()">üì§ Upload</button>
                        <button class="btn btn-secondary" onclick="exportPartnersCSV()">üìä Export CSV</button>
                        <input type="file" id="uploadPartnersFile" accept=".json" style="display: none;" onchange="uploadPartnersJSON(event)">
                    </div>
                </div>
                <div class="card-body">
                    <div class="toolbar">
                        <div class="search-box">
                            <input type="text" id="partnerSearch" class="form-input" placeholder="üîç Search..." onkeyup="filterPartnerTable()">
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Categories</th>
                                    <th>Location</th>
                                    <th>Agreement</th>
                                    <th>Value (‡∏øM)</th>
                                    <th>Expiry</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="partnersTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="save-button-container">
                <button class="btn btn-success btn-save" onclick="saveAllPartnersData()">üíæ Save</button>
            </div>
        </div>

        <!-- Manage Projects View -->
        <div id="manageProjectsView" class="view">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Manage Projects</h2>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="openProjectModal()">‚ûï Add</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('uploadProjectsFile').click()">üì§ Upload</button>
                        <button class="btn btn-secondary" onclick="exportProjectsCSV()">üìä Export CSV</button>
                        <input type="file" id="uploadProjectsFile" accept=".json" style="display: none;" onchange="uploadProjectsJSON(event)">
                    </div>
                </div>
                <div class="card-body">
                    <div class="toolbar">
                        <div class="search-box">
                            <input type="text" id="projectSearch" class="form-input" placeholder="üîç Search..." onkeyup="filterProjectsTable()">
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Partner</th>
                                    <th>Phase</th>
                                    <th>Progress</th>
                                    <th>Cost (‡∏øM)</th>
                                    <th>Team Size</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="projectsManageTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="save-button-container">
                <button class="btn btn-success btn-save" onclick="saveAllProjectsData()">üíæ Save</button>
            </div>
        </div>

        <!-- Manage Members View -->
        <div id="manageMembersView" class="view">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Manage Members</h2>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="openMemberModal()">‚ûï Add</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('uploadMembersFile').click()">üì§ Upload</button>
                        <button class="btn btn-secondary" onclick="exportMembersCSV()">üìä Export CSV</button>
                        <input type="file" id="uploadMembersFile" accept=".json" style="display: none;" onchange="uploadMembersJSON(event)">
                    </div>
                </div>
                <div class="card-body">
                    <div class="toolbar">
                        <div class="search-box">
                            <input type="text" id="memberSearch" class="form-input" placeholder="üîç Search..." onkeyup="filterMemberTable()">
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Company</th>
                                    <th>Department</th>
                                    <th>Roles</th>
                                    <th>Phone</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="save-button-container">
                <button class="btn btn-success btn-save" onclick="saveAllMembers()">üíæ Save</button>
            </div>
        </div>

        <!-- Manage Roles View -->
        <div id="manageRolesView" class="view">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Manage Roles</h2>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="addNewRole()">‚ûï Add</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('uploadRolesFile').click()">üì§ Upload</button>
                        <button class="btn btn-secondary" onclick="exportRolesCSV()">üìä Export CSV</button>
                        <input type="file" id="uploadRolesFile" accept=".json" style="display: none;" onchange="uploadRolesJSON(event)">
                    </div>
                </div>
                <div class="card-body">
                    <div class="info-box">
                        <strong>‚ÑπÔ∏è Info:</strong> Roles define positions and responsibilities within projects.
                    </div>
                    <div class="role-list" id="roleList"></div>
                </div>
            </div>
            <div class="save-button-container">
                <button class="btn btn-success btn-save" onclick="saveAllRoles()">üíæ Save</button>
            </div>
        </div>

        <!-- Manage Categories View -->
        <div id="manageCategoriesView" class="view">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Manage Categories</h2>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="addNewCategory()">‚ûï Add</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('uploadCategoriesFile').click()">üì§ Upload</button>
                        <button class="btn btn-secondary" onclick="exportCategoriesCSV()">üìä Export CSV</button>
                        <input type="file" id="uploadCategoriesFile" accept=".json" style="display: none;" onchange="uploadCategoriesJSON(event)">
                    </div>
                </div>
                <div class="card-body">
                    <div class="info-box">
                        <strong>‚ÑπÔ∏è Info:</strong> Categories classify partners with custom colors.
                    </div>
                    <div class="category-list" id="categoryList"></div>
                </div>
            </div>
            <div class="save-button-container">
                <button class="btn btn-success btn-save" onclick="saveAllCategories()">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- Partner Modal -->
    <div id="partnerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="partnerModalTitle">Partner</h3>
                <button class="modal-close" onclick="closePartnerModal()">&times;</button>
            </div>
            <div class="modal-body" id="partnerModalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePartnerModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePartner()">Save</button>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="projectModalTitle">Project</h3>
                <button class="modal-close" onclick="closeProjectModal()">&times;</button>
            </div>
            <div class="modal-body" id="projectModalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()">Save</button>
            </div>
        </div>
    </div>

    <!-- Member Modal -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="memberModalTitle">Member</h3>
                <button class="modal-close" onclick="closeMemberModal()">&times;</button>
            </div>
            <div class="modal-body" id="memberModalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMemberModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveMember()">Save</button>
            </div>
        </div>
    </div>

    </div><!-- END mainApp -->

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ========== AZURE AD CONFIGURATION ==========
        // TODO: Replace with your Azure AD App Registration values
        const msalConfig = {
            auth: {
                clientId: "2b35dd2c-28b8-4186-a481-ba484248852a",  // Replace with your Application (client) ID
                authority: "https://login.microsoftonline.com/5db8bf0e-8592-4ed0-82b2-a6d4d77933d4",  // Replace with your Directory (tenant) ID
                redirectUri: window.location.origin,
                postLogoutRedirectUri: window.location.origin
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            },
            system: {
                loggerOptions: {
                    logLevel: 3  // Warning level
                }
            }
        };

        const loginRequest = {
            scopes: ["User.Read", "openid", "profile", "email"]
        };

        let msalInstance = null;
        let currentUser = null;

        // ========== AUTHENTICATION FUNCTIONS ==========
        async function initAuth() {
            try {
                // Check if MSAL library is loaded
                if (typeof msal === 'undefined') {
                    console.error("MSAL library not loaded");
                    return null;
                }

                // Skip initialization if config has placeholder values
                if (msalConfig.auth.clientId === "YOUR_CLIENT_ID" || msalConfig.auth.authority.includes("YOUR_TENANT_ID")) {
                    console.warn("Azure AD not configured - please set Client ID and Tenant ID");
                    msalInstance = null;
                    return null;
                }

                console.log("Creating MSAL instance...");
                msalInstance = new msal.PublicClientApplication(msalConfig);

                // MSAL 2.x requires explicit initialization
                console.log("Initializing MSAL...");
                await msalInstance.initialize();

                // Handle redirect response (important: must be called after initialize)
                console.log("Handling redirect promise...");
                const response = await msalInstance.handleRedirectPromise();

                if (response) {
                    // Login successful after redirect
                    currentUser = response.account;
                    console.log("Login successful:", currentUser);
                } else {
                    // Check existing session
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        currentUser = accounts[0];
                        msalInstance.setActiveAccount(currentUser);
                    }
                }

                return currentUser;
            } catch (error) {
                console.error("Auth initialization error:", error);
                // Store the actual error for debugging
                window.lastAuthError = error;
                msalInstance = null;
                return null;
            }
        }

        async function login() {
            try {
                // Check if MSAL library is loaded
                if (typeof msal === 'undefined') {
                    throw new Error("MSAL library ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
                }

                // Check if config has placeholder values
                if (msalConfig.auth.clientId === "YOUR_CLIENT_ID" || msalConfig.auth.authority.includes("YOUR_TENANT_ID")) {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Azure AD ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:\n\n1. ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå index.html\n2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ 'YOUR_CLIENT_ID' ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Application (client) ID\n3. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ 'YOUR_TENANT_ID' ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Directory (tenant) ID\n\n‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Azure Portal > App registrations");
                    return;
                }

                // Initialize MSAL if not done yet
                if (!msalInstance) {
                    await initAuth();
                }

                if (!msalInstance) {
                    // Show detailed error if available
                    const detailedError = window.lastAuthError ?
                        "\n\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: " + (window.lastAuthError.message || window.lastAuthError.toString()) : "";
                    throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Azure AD ‡πÑ‡∏î‡πâ" + detailedError);
                }

                // Show loading state
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('loginLoading').classList.add('active');

                // Redirect to Microsoft login
                await msalInstance.loginRedirect(loginRequest);
            } catch (error) {
                console.error("Login error:", error);
                // Show login button again on error
                document.getElementById('loginButton').style.display = 'block';
                document.getElementById('loginLoading').classList.remove('active');
                alert("Login failed: " + error.message);
            }
        }

        async function logout() {
            try {
                currentUser = null;
                await msalInstance.logoutRedirect({
                    postLogoutRedirectUri: window.location.origin
                });
            } catch (error) {
                console.error("Logout error:", error);
                sessionStorage.clear();
                window.location.reload();
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function updateUserInfo() {
            if (currentUser) {
                const userName = document.getElementById('userName');
                const userEmail = document.getElementById('userEmail');

                userName.textContent = currentUser.name || currentUser.username || 'User';
                userEmail.textContent = currentUser.username || '';
            }
        }

        // Global State
        let partners = [];
        let projects = [];
        let categories = [];
        let members = [];
        let roles = [];

        // ========== SUPABASE CONFIGURATION ==========
        const SUPABASE_URL = 'https://mxqjcqagizeqnfkomemr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14cWpjcWFnaXplcW5ma29tZW1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMDE2MjUsImV4cCI6MjA4Mzc3NzYyNX0.ZmZ3iLHhOa1tRAdtvHi_zzRbFEVAAR_AcCmjUK6-h18';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let map = null;
        let markersLayer = null;
        let currentPartner = null;
        let currentProject = null;
        let currentMember = null;
        let editMode = false;
        let fileHandles = {};
        let charts = {};

        const PHASES = ['2P2S','O&M','Execution','Ideate', 'Incubate', 'Introduction', 'Growth', 'Mature', 'Decline','Phase-Out','Obsolescence', 'EndOfLife'];
        const STATUS_DIMENSIONS = ['marketStatus', 'profitabilityStatus', 'scalabilityStatus', 'resourceStatus', 'technologyStatus', 'budgetStatus', 'riskStatus', 'scheduleStatus'];
        const DIMENSION_LABELS = {
            marketStatus: 'Market', profitabilityStatus: 'Profitability', scalabilityStatus: 'Scalability', resourceStatus: 'Resource',
            technologyStatus: 'Technology', budgetStatus: 'Budget', riskStatus: 'Risk', scheduleStatus: 'Schedule'
        };
        const MONTHS = ['Month 1', 'Month 2', 'Month 3', 'Month 4', 'Month 5', 'Month 6', 'Month 7', 'Month 8', 'Month 9', 'Month 10', 'Month 11', 'Month 12'];

        // ========== INITIALIZATION ==========
        async function init() {
            try {
                // 1. Initialize Authentication first
                await initAuth();

                // 2. Check if user is logged in
                if (!currentUser) {
                    // Not logged in - show login page
                    showLoginPage();
                    return;
                }

                // 3. User is logged in - show main app
                showMainApp();
                updateUserInfo();

                // 4. Load data and initialize components
                await loadData();
                initMap();
                populateFilters();
                updateDashboard();
                updatePortfolio();
                updatePartnerTable();
                updateProjectsManageTable();
                updateMemberTable();
                updateRoleList();
                updateCategoryList();
                updateNotifications();
                initializeCharts();
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize: ' + error.message);
            }
        }

        async function loadData() {
            try {
                // Load data from Supabase
                const [partnersRes, projectsRes, categoriesRes, membersRes, rolesRes] = await Promise.all([
                    supabaseClient.from('partners').select('*'),
                    supabaseClient.from('projects').select('*'),
                    supabaseClient.from('categories').select('*'),
                    supabaseClient.from('members').select('*'),
                    supabaseClient.from('roles').select('*')
                ]);

                // Transform Supabase data to match app format (snake_case to camelCase)
                partners = (partnersRes.data || []).map(p => ({
                    id: p.id,
                    name: p.name,
                    categories: p.categories || [],
                    location: p.location || {},
                    contact: p.contact || {},
                    scope: p.scope || '',
                    agreementType: p.agreement_type || '',
                    agreementDoc: p.agreement_doc || '',
                    agreementPurpose: p.agreement_purpose || '',
                    contractValue: p.contract_value,
                    liabilities: p.liabilities || '',
                    effectiveDate: p.effective_date || '',
                    expiryDate: p.expiry_date || '',
                    notes: p.notes || '',
                    agreement: p.agreement || {},
                    agreementPeriod: p.agreement_period
                }));

                projects = (projectsRes.data || []).map(p => ({
                    id: p.id,
                    partnerId: p.partner_id,
                    name: p.name,
                    scope: p.scope || '',
                    expectation: p.expectation || '',
                    startTime: p.start_time || '',
                    endTime: p.end_time || '',
                    cost: p.cost || 0,
                    progress: p.progress || 0,
                    phase: p.phase || '',
                    teamMembers: p.team_members || [],
                    kpis: p.kpis || [],
                    marketStatus: p.market_status || 'Green',
                    profitabilityStatus: p.profitability_status || 'Green',
                    scalabilityStatus: p.scalability_status || 'Green',
                    resourceStatus: p.resource_status || 'Green',
                    technologyStatus: p.technology_status || 'Green',
                    budgetStatus: p.budget_status || 'Green',
                    riskStatus: p.risk_status || 'Green',
                    scheduleStatus: p.schedule_status || 'Green'
                }));

                categories = (categoriesRes.data || []).map(c => ({
                    id: c.id,
                    name: c.name,
                    color: c.color
                }));

                members = (membersRes.data || []).map(m => ({
                    id: m.id,
                    firstName: m.first_name || '',
                    lastName: m.last_name || '',
                    email: m.email || '',
                    phone: m.phone || '',
                    company: m.company || '',
                    department: m.department || '',
                    title: m.title || '',
                    location: m.location || '',
                    roles: m.roles || [],
                    skills: m.skills || [],
                    notes: m.notes || ''
                }));

                roles = (rolesRes.data || []).map(r => ({
                    id: r.id,
                    name: r.name,
                    color: r.color,
                    description: r.description || ''
                }));

                // Check for errors
                const errors = [partnersRes.error, projectsRes.error, categoriesRes.error, membersRes.error, rolesRes.error].filter(Boolean);
                if (errors.length > 0) {
                    console.warn('Some data failed to load from Supabase:', errors);
                    showWarning('Some data failed to load. Check console for details.');
                }

                console.log('Loaded from Supabase:', partners.length, 'partners,', projects.length, 'projects,', categories.length, 'categories,', members.length, 'members,', roles.length, 'roles');
            } catch (error) {
                showError('Error loading data from Supabase: ' + error.message);
                console.error('Supabase load error:', error);
            }
        }

        // ========== SUPABASE CRUD HELPERS ==========
        // Convert app format (camelCase) to database format (snake_case)
        function partnerToDb(p) {
            return {
                id: p.id,
                name: p.name,
                categories: p.categories || [],
                location: p.location || {},
                contact: p.contact || {},
                scope: p.scope || '',
                agreement_type: p.agreementType || '',
                agreement_doc: p.agreementDoc || '',
                agreement_purpose: p.agreementPurpose || '',
                contract_value: p.contractValue,
                liabilities: p.liabilities || '',
                effective_date: p.effectiveDate || '',
                expiry_date: p.expiryDate || '',
                notes: p.notes || '',
                agreement: p.agreement || {},
                agreement_period: p.agreementPeriod
            };
        }

        function projectToDb(p) {
            return {
                id: p.id,
                partner_id: p.partnerId,
                name: p.name,
                scope: p.scope || '',
                expectation: p.expectation || '',
                start_time: p.startTime || '',
                end_time: p.endTime || '',
                cost: p.cost || 0,
                progress: p.progress || 0,
                phase: p.phase || '',
                team_members: p.teamMembers || [],
                kpis: p.kpis || [],
                market_status: p.marketStatus || 'Green',
                profitability_status: p.profitabilityStatus || 'Green',
                scalability_status: p.scalabilityStatus || 'Green',
                resource_status: p.resourceStatus || 'Green',
                technology_status: p.technologyStatus || 'Green',
                budget_status: p.budgetStatus || 'Green',
                risk_status: p.riskStatus || 'Green',
                schedule_status: p.scheduleStatus || 'Green'
            };
        }

        function memberToDb(m) {
            return {
                id: m.id,
                first_name: m.firstName || '',
                last_name: m.lastName || '',
                email: m.email || '',
                phone: m.phone || '',
                company: m.company || '',
                department: m.department || '',
                title: m.title || '',
                location: m.location || '',
                roles: m.roles || [],
                skills: m.skills || [],
                notes: m.notes || ''
            };
        }

        async function savePartnerToSupabase(partnerData) {
            const dbData = partnerToDb(partnerData);
            const { error } = await supabaseClient.from('partners').upsert(dbData, { onConflict: 'id' });
            if (error) throw error;
        }

        async function deletePartnerFromSupabase(partnerId) {
            const { error } = await supabaseClient.from('partners').delete().eq('id', partnerId);
            if (error) throw error;
        }

        async function saveProjectToSupabase(projectData) {
            const dbData = projectToDb(projectData);
            const { error } = await supabaseClient.from('projects').upsert(dbData, { onConflict: 'id' });
            if (error) throw error;
        }

        async function deleteProjectFromSupabase(projectId) {
            const { error } = await supabaseClient.from('projects').delete().eq('id', projectId);
            if (error) throw error;
        }

        async function saveMemberToSupabase(memberData) {
            const dbData = memberToDb(memberData);
            const { error } = await supabaseClient.from('members').upsert(dbData, { onConflict: 'id' });
            if (error) throw error;
        }

        async function deleteMemberFromSupabase(memberId) {
            const { error } = await supabaseClient.from('members').delete().eq('id', memberId);
            if (error) throw error;
        }

        async function saveRoleToSupabase(roleData) {
            const { error } = await supabaseClient.from('roles').upsert(roleData, { onConflict: 'id' });
            if (error) throw error;
        }

        async function deleteRoleFromSupabase(roleId) {
            const { error } = await supabaseClient.from('roles').delete().eq('id', roleId);
            if (error) throw error;
        }

        async function saveCategoryToSupabase(categoryData) {
            const { error } = await supabaseClient.from('categories').upsert(categoryData, { onConflict: 'id' });
            if (error) throw error;
        }

        async function deleteCategoryFromSupabase(categoryId) {
            const { error } = await supabaseClient.from('categories').delete().eq('id', categoryId);
            if (error) throw error;
        }

        // ========== FILE SYSTEM ACCESS API (Legacy - kept for backup) ==========
        async function saveToFile(data, fileName, fileType) {
            const jsonString = JSON.stringify(data, null, 2);
            
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }]
                    });
                    
                    const writable = await handle.createWritable();
                    await writable.write(jsonString);
                    await writable.close();
                    
                    fileHandles[fileType] = handle;
                    showSuccess(`${fileName} saved successfully!`);
                    return true;
                } catch (error) {
                    if (error.name === 'AbortError') {
                        showWarning('Save cancelled');
                        return false;
                    }
                    showError('Error saving: ' + error.message);
                    return false;
                }
            } else {
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.click();
                URL.revokeObjectURL(url);
                showWarning(`Downloaded as ${fileName}. Please replace in ./data/ folder.`);
                return true;
            }
        }

        // ========== MESSAGES ==========
        function showSuccess(msg) {
            const alert = document.getElementById('successAlert');
            alert.textContent = msg;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        function showError(msg) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = msg;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        function showWarning(msg) {
            const alert = document.getElementById('warningAlert');
            alert.textContent = msg;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        // ========== NAVIGATION ==========
        function showView(viewName) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');

            const viewHandlers = {
                dashboard: updateDashboard,
                portfolio: updatePortfolio,
                map: () => map && setTimeout(() => map.invalidateSize(), 100),
                managePartners: updatePartnerTable,
                manageProjects: updateProjectsManageTable,
                manageMembers: updateMemberTable,
                manageRoles: updateRoleList,
                manageCategories: updateCategoryList,
                notifications: updateNotifications,
                resources: updateResourceCharts
            };

            if (viewHandlers[viewName]) viewHandlers[viewName]();
        }

        // ========== MAP ==========
        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            updateMapMarkers();
        }

        function updateMapMarkers() {
            if (!map || !markersLayer) return;
            markersLayer.clearLayers();
            const categoryFilter = document.getElementById('mapCategoryFilter')?.value || '';
            const bounds = [];

            partners.forEach(partner => {
                if (categoryFilter) {
                    const hasCategory = partner.categories?.some(c => {
                        const cat = categories.find(cat => cat.id === c || cat.name === c);
                        return cat && (cat.id === categoryFilter || cat.name === categoryFilter);
                    });
                    if (!hasCategory) return;
                }

                if (!partner.location?.latitude || !partner.location?.longitude) return;

                const primaryCat = partner.categories?.[0];
                const cat = categories.find(c => c.id === primaryCat || c.name === primaryCat);
                const color = cat?.color || '#64748b';

                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                const marker = L.marker([partner.location.latitude, partner.location.longitude], { icon })
                    .bindPopup(createPopupContent(partner));
                markersLayer.addLayer(marker);
                bounds.push([partner.location.latitude, partner.location.longitude]);
            });

            if (bounds.length > 0 && !categoryFilter) map.fitBounds(bounds);
        }

        function createPopupContent(partner) {
            const partnerProjects = projects.filter(p => p.partnerId === partner.id);
            const categoryBadges = (partner.categories || []).map(catId => {
                const cat = categories.find(c => c.id === catId || c.name === catId);
                if (!cat) return '';
                return `<span class="category-badge" style="background: ${cat.color}">${cat.name}</span>`;
            }).join('');

            return `
                <div style="min-width: 200px;">
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem;">${partner.name}</h3>
                    <div style="margin: 0.5rem 0;">${categoryBadges}</div>
                    <p style="margin: 0.25rem 0; font-size: 0.875rem;"><strong>Location:</strong> ${partner.location.city}, ${partner.location.country}</p>
                    <p style="margin: 0.25rem 0; font-size: 0.875rem;"><strong>Projects:</strong> ${partnerProjects.length}</p>
                    ${partner.agreementType ? `<p style="margin: 0.25rem 0; font-size: 0.875rem;"><strong>Agreement:</strong> ${partner.agreementType}</p>` : ''}
                </div>
            `;
        }

        function fitMapToMarkers() {
            if (!map || !markersLayer) return;
            const bounds = [];
            markersLayer.eachLayer(layer => {
                if (layer instanceof L.Marker) bounds.push(layer.getLatLng());
            });
            if (bounds.length > 0) map.fitBounds(bounds);
        }

        function filterMapMarkers() {
            updateMapMarkers();
        }

        // ========== DASHBOARD ==========
        function updateDashboard() {
            updateSummaryCards();
            updateProjectTable();
        }

        function updateSummaryCards() {
            document.getElementById('totalProjects').textContent = projects.length;
            document.getElementById('totalPartners').textContent = partners.length;
            const avgProgress = projects.length > 0 ? Math.round(projects.reduce((s, p) => s + (p.progress || 0), 0) / projects.length) : 0;
            document.getElementById('avgProgress').textContent = avgProgress + '%';
            
            let criticalIssues = 0;
            projects.forEach(p => STATUS_DIMENSIONS.forEach(d => { if (p[d] === 'Red') criticalIssues++; }));
            document.getElementById('criticalIssues').textContent = criticalIssues;
        }

        function updateProjectTable() {
            const container = document.getElementById('projectTableContainer');
            const filtered = getFilteredProjects('dashboard');

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><p>No projects</p></div>';
                return;
            }

            let html = '<table class="data-table"><thead><tr><th>Partner</th><th>Project</th><th>Phase</th><th>Progress</th><th>Status</th><th>Action</th></tr></thead><tbody>';

            filtered.forEach(project => {
                const partner = partners.find(p => p.id === project.partnerId);
                if (!partner) return;

                html += `
                    <tr>
                        <td>${partner.name}</td>
                        <td><strong>${project.name}</strong></td>
                        <td>${project.phase || 'N/A'}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div class="progress-bar"><div class="progress-fill" style="width: ${project.progress || 0}%"></div></div>
                                <span style="font-size: 0.875rem;">${project.progress || 0}%</span>
                            </div>
                        </td>
                        <td>
                            <div class="status-indicators">
                                ${STATUS_DIMENSIONS.map(d => `<div class="status-dot status-${(project[d] || 'Green').toLowerCase()}" data-tooltip="${DIMENSION_LABELS[d]}: ${project[d] || 'N/A'}"></div>`).join('')}
                            </div>
                        </td>
                        <td><button class="btn btn-primary btn-sm" onclick="openProjectModal('${project.id}')">View</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function getFilteredProjects(context) {
            const partnerFilter = document.getElementById(context + 'PartnerFilter')?.value || '';
            const categoryFilter = document.getElementById(context + 'CategoryFilter')?.value || '';
            const phaseFilter = document.getElementById(context + 'PhaseFilter')?.value || '';
            const statusFilter = document.getElementById(context + 'StatusFilter')?.value || '';

            return projects.filter(project => {
                const partner = partners.find(p => p.id === project.partnerId);
                if (!partner) return false;
                if (partnerFilter && project.partnerId !== partnerFilter) return false;
                if (categoryFilter) {
                    const hasCategory = partner.categories?.some(c => {
                        const cat = categories.find(cat => cat.id === c || cat.name === c);
                        return cat && (cat.id === categoryFilter || cat.name === categoryFilter);
                    });
                    if (!hasCategory) return false;
                }
                if (phaseFilter && project.phase !== phaseFilter) return false;
                if (statusFilter && !STATUS_DIMENSIONS.some(d => project[d] === statusFilter)) return false;
                return true;
            });
        }

        function filterDashboard() { updateProjectTable(); }
        function resetDashboardFilters() {
            ['dashboardPartnerFilter', 'dashboardCategoryFilter', 'dashboardPhaseFilter', 'dashboardStatusFilter']
                .forEach(id => document.getElementById(id).value = '');
            updateProjectTable();
        }

        // ========== PORTFOLIO ==========
        function updatePortfolio() {
            const container = document.getElementById('portfolioBoard');
            const filtered = getFilteredProjects('portfolio');
            container.innerHTML = '';

            PHASES.forEach(phase => {
                const phaseProjects = filtered.filter(p => p.phase === phase);
                const column = document.createElement('div');
                column.className = 'portfolio-column';

                let html = `<div class="portfolio-column-header">${phase} (${phaseProjects.length})</div><div class="portfolio-column-body">`;

                if (phaseProjects.length === 0) {
                    html += '<div style="text-align: center; padding: 2rem; color: var(--text-secondary); font-size: 0.875rem;">No projects</div>';
                } else {
                    phaseProjects.forEach(project => {
                        const partner = partners.find(p => p.id === project.partnerId);
                        if (!partner) return;
                        const worstStatus = getWorstStatus(project);

                        html += `
                            <div class="project-card" onclick="openProjectModal('${project.id}')">
                                <div class="project-card-title">${project.name}</div>
                                <div class="project-card-partner">${partner.name}</div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                    <div class="status-dot status-${worstStatus.toLowerCase()}" style="width: 16px; height: 16px;"></div>
                                    <span style="font-size: 0.75rem;">${worstStatus}</span>
                                </div>
                                <div style="margin-top: 0.5rem;">
                                    <div class="progress-bar" style="width: 100%; margin-bottom: 0.25rem;">
                                        <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                                    </div>
                                    <span style="font-size: 0.75rem;">${project.progress || 0}%</span>
                                </div>
                            </div>
                        `;
                    });
                }

                html += '</div>';
                column.innerHTML = html;
                container.appendChild(column);
            });
        }

        function getWorstStatus(project) {
            let hasRed = false, hasYellow = false;
            STATUS_DIMENSIONS.forEach(d => {
                if (project[d] === 'Red') hasRed = true;
                if (project[d] === 'Yellow') hasYellow = true;
            });
            return hasRed ? 'Red' : hasYellow ? 'Yellow' : 'Green';
        }

        function filterPortfolio() { updatePortfolio(); }
        function resetPortfolioFilters() {
            ['portfolioPartnerFilter', 'portfolioCategoryFilter', 'portfolioStatusFilter'].forEach(id => document.getElementById(id).value = '');
            updatePortfolio();
        }

        // ========== NOTIFICATIONS ==========
        function updateNotifications() {
            const warningDays = parseInt(document.getElementById('warningDays')?.value || 90);
            const today = new Date();
            const warningDate = new Date(today.getTime() + warningDays * 24 * 60 * 60 * 1000);
            
            const notifications = [];
            
            partners.forEach(partner => {
                if (!partner.expiryDate) return;
                const expiryDate = new Date(partner.expiryDate);
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (24 * 60 * 60 * 1000));
                
                if (daysUntilExpiry < 0) {
                    notifications.push({
                        type: 'critical',
                        partner: partner.name,
                        agreementType: partner.agreementType || 'Agreement',
                        expiryDate: partner.expiryDate,
                        daysUntilExpiry: daysUntilExpiry,
                        message: `OVERDUE by ${Math.abs(daysUntilExpiry)} days`
                    });
                } else if (daysUntilExpiry <= warningDays) {
                    notifications.push({
                        type: 'warning',
                        partner: partner.name,
                        agreementType: partner.agreementType || 'Agreement',
                        expiryDate: partner.expiryDate,
                        daysUntilExpiry: daysUntilExpiry,
                        message: `Expires in ${daysUntilExpiry} days`
                    });
                }
            });

            const badge = document.getElementById('notificationCount');
            if (notifications.length > 0) {
                badge.textContent = notifications.length;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }

            const container = document.getElementById('notificationsList');
            if (notifications.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>No upcoming expirations</p></div>';
                return;
            }

            container.innerHTML = notifications.map(n => `
                <div class="notification-item ${n.type}">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4 style="margin-bottom: 0.5rem;">${n.partner}</h4>
                            <p style="margin: 0.25rem 0; font-size: 0.875rem;"><strong>Type:</strong> ${n.agreementType}</p>
                            <p style="margin: 0.25rem 0; font-size: 0.875rem;"><strong>Expiry:</strong> ${n.expiryDate}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-size: 1.25rem; font-weight: 700; color: ${n.type === 'critical' ? 'var(--status-red)' : 'var(--status-yellow)'};">
                                ${n.message}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ========== PARTNER MANAGEMENT ==========
        function updatePartnerTable() {
            const tbody = document.getElementById('partnersTableBody');
            const searchTerm = document.getElementById('partnerSearch')?.value.toLowerCase() || '';
            const filtered = partners.filter(p => 
                p.name.toLowerCase().includes(searchTerm) ||
                p.location?.city?.toLowerCase().includes(searchTerm)
            );

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No partners</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(p => {
                const catBadges = (p.categories || []).map(cId => {
                    const cat = categories.find(c => c.id === cId || c.name === cId);
                    return cat ? `<span class="category-badge" style="background: ${cat.color}">${cat.name}</span>` : '';
                }).join('');

                const expiry = p.expiryDate ? new Date(p.expiryDate) : null;
                const daysLeft = expiry ? Math.ceil((expiry - new Date()) / (24*60*60*1000)) : null;
                const expiryColor = daysLeft < 0 ? 'var(--status-red)' : daysLeft < 90 ? 'var(--status-yellow)' : '';

                return `
                    <tr>
                        <td><strong>${p.name}</strong></td>
                        <td>${catBadges || 'N/A'}</td>
                        <td>${p.location?.city || 'N/A'}, ${p.location?.country || 'N/A'}</td>
                        <td>${p.agreementType || 'N/A'}</td>
                        <td>${p.contractValue ? p.contractValue.toFixed(2) : 'N/A'}</td>
                        <td style="color: ${expiryColor}; font-weight: ${expiryColor ? '600' : 'normal'};">${p.expiryDate || 'N/A'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="editPartner('${p.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-sm" onclick="deletePartner('${p.id}')">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterPartnerTable() { updatePartnerTable(); }

        function openPartnerModal(partnerId = null) {
            editMode = !!partnerId;
            currentPartner = partnerId ? partners.find(p => p.id === partnerId) : null;
            document.getElementById('partnerModalTitle').textContent = editMode ? 'Edit Partner' : 'Add Partner';

            const p = currentPartner || {};
            const modalBody = document.getElementById('partnerModalBody');
            
            modalBody.innerHTML = `
                <form id="partnerForm">
                    <div class="section-title">üìã Basic Information</div>
                    <div class="form-group">
                        <label class="form-label">Partner Name *</label>
                        <input type="text" class="form-input" id="partnerName" value="${p.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categories *</label>
                        <div class="category-checkbox-group" id="partnerCategoryCheckboxes"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Contact Person *</label>
                            <input type="text" class="form-input" id="partnerContactPerson" value="${p.contact?.person || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-input" id="partnerEmail" value="${p.contact?.email || ''}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-input" id="partnerPhone" value="${p.contact?.phone || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <input type="text" class="form-input" id="partnerAddress" value="${p.location?.address || ''}">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label class="form-label">City *</label>
                            <input type="text" class="form-input" id="partnerCity" value="${p.location?.city || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Country *</label>
                            <input type="text" class="form-input" id="partnerCountry" value="${p.location?.country || ''}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Latitude *</label>
                            <input type="number" step="any" class="form-input" id="partnerLatitude" value="${p.location?.latitude || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Longitude *</label>
                            <input type="number" step="any" class="form-input" id="partnerLongitude" value="${p.location?.longitude || ''}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Scope *</label>
                        <textarea class="form-input" id="partnerScope" required>${p.scope || ''}</textarea>
                    </div>

                    <hr class="section-divider">
                    <div class="section-title">üìÑ Agreement Details</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Agreement Type</label>
                            <select class="form-input" id="partnerAgreementType">
                                <option value="">Select Type</option>
                                <option value="NDA" ${p.agreementType === 'NDA' ? 'selected' : ''}>NDA</option>
                                <option value="MOU" ${p.agreementType === 'MOU' ? 'selected' : ''}>MOU</option>
                                <option value="Contract" ${p.agreementType === 'Contract' ? 'selected' : ''}>Contract</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Agreement Doc</label>
                            <input type="text" class="form-input" id="partnerAgreementDoc" value="${p.agreementDoc || ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Agreement/Purpose</label>
                        <textarea class="form-input" id="partnerAgreementPurpose">${p.agreementPurpose || ''}</textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Contract Value (‡∏ø Million)</label>
                            <input type="number" step="0.01" class="form-input" id="partnerContractValue" value="${p.contractValue || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Liabilities/Obligation</label>
                            <input type="text" class="form-input" id="partnerLiabilities" value="${p.liabilities || ''}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Effective Date</label>
                            <input type="date" class="form-input" id="partnerEffectiveDate" value="${p.effectiveDate || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Expiry Date</label>
                            <input type="date" class="form-input" id="partnerExpiryDate" value="${p.expiryDate || ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-input" id="partnerNotes">${p.notes || ''}</textarea>
                    </div>
                </form>
            `;

            populateCategoryCheckboxes(p.categories || []);
            document.getElementById('partnerModal').classList.add('show');
        }

        function closePartnerModal() {
            document.getElementById('partnerModal').classList.remove('show');
            currentPartner = null;
            editMode = false;
        }

        function populateCategoryCheckboxes(selected = []) {
            const container = document.getElementById('partnerCategoryCheckboxes');
            if (categories.length === 0) {
                container.innerHTML = '<p style="padding: 1rem;">No categories available</p>';
                return;
            }
            const sortedCategories = [...categories].sort((a, b) => a.name.localeCompare(b.name));
            container.innerHTML = sortedCategories.map(cat => {
                const isChecked = selected.includes(cat.id) || selected.includes(cat.name);
                return `
                    <label class="category-checkbox-item">
                        <input type="checkbox" name="partnerCategory" value="${cat.id}" ${isChecked ? 'checked' : ''}>
                        <div class="category-color-indicator" style="background: ${cat.color}"></div>
                        <span>${cat.name}</span>
                    </label>
                `;
            }).join('');
        }

        async function savePartner() {
            const form = document.getElementById('partnerForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const selectedCategories = Array.from(document.querySelectorAll('input[name="partnerCategory"]:checked')).map(cb => cb.value);
            if (selectedCategories.length === 0) {
                showError('Select at least one category');
                return;
            }

            const partnerData = {
                id: editMode && currentPartner ? currentPartner.id : 'p' + Date.now(),
                name: document.getElementById('partnerName').value,
                categories: selectedCategories,
                location: {
                    address: document.getElementById('partnerAddress').value,
                    city: document.getElementById('partnerCity').value,
                    country: document.getElementById('partnerCountry').value,
                    latitude: parseFloat(document.getElementById('partnerLatitude').value),
                    longitude: parseFloat(document.getElementById('partnerLongitude').value)
                },
                contact: {
                    person: document.getElementById('partnerContactPerson').value,
                    email: document.getElementById('partnerEmail').value,
                    phone: document.getElementById('partnerPhone').value
                },
                scope: document.getElementById('partnerScope').value,
                agreementType: document.getElementById('partnerAgreementType').value,
                agreementDoc: document.getElementById('partnerAgreementDoc').value,
                agreementPurpose: document.getElementById('partnerAgreementPurpose').value,
                contractValue: parseFloat(document.getElementById('partnerContractValue').value) || null,
                liabilities: document.getElementById('partnerLiabilities').value,
                effectiveDate: document.getElementById('partnerEffectiveDate').value,
                expiryDate: document.getElementById('partnerExpiryDate').value,
                notes: document.getElementById('partnerNotes').value
            };

            try {
                // Save to Supabase
                await savePartnerToSupabase(partnerData);

                if (editMode && currentPartner) {
                    const index = partners.findIndex(p => p.id === currentPartner.id);
                    partners[index] = partnerData;
                    showSuccess('Partner updated!');
                } else {
                    partners.push(partnerData);
                    showSuccess('Partner added!');
                }

                closePartnerModal();
                updatePartnerTable();
                updateMapMarkers();
                populateFilters();
                updateNotifications();
            } catch (error) {
                showError('Failed to save partner: ' + error.message);
                console.error('Save partner error:', error);
            }
        }

        function editPartner(partnerId) { openPartnerModal(partnerId); }

        async function deletePartner(partnerId) {
            if (!confirm('Delete partner and all projects?')) return;

            try {
                // Delete partner and related projects from Supabase
                const relatedProjects = projects.filter(p => p.partnerId === partnerId);
                for (const proj of relatedProjects) {
                    await deleteProjectFromSupabase(proj.id);
                }
                await deletePartnerFromSupabase(partnerId);

                partners = partners.filter(p => p.id !== partnerId);
                projects = projects.filter(p => p.partnerId !== partnerId);
                showSuccess('Partner deleted!');
                updatePartnerTable();
                updateMapMarkers();
                populateFilters();
                updateDashboard();
                updateNotifications();
            } catch (error) {
                showError('Failed to delete partner: ' + error.message);
                console.error('Delete partner error:', error);
            }
        }

        async function saveAllPartnersData() {
            await saveToFile(partners, 'partners.json', 'partners');
        }

        function uploadPartnersJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        partners = data;
                        showSuccess('Partners uploaded!');
                        updatePartnerTable();
                        updateMapMarkers();
                        populateFilters();
                    } else {
                        showError('Invalid format');
                    }
                } catch (error) {
                    showError('Parse error: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ========== PROJECT MANAGEMENT ==========
        function updateProjectsManageTable() {
            const tbody = document.getElementById('projectsManageTableBody');
            const searchTerm = document.getElementById('projectSearch')?.value.toLowerCase() || '';
            const filtered = projects.filter(p => {
                const partner = partners.find(pt => pt.id === p.partnerId);
                return p.name?.toLowerCase().includes(searchTerm) || partner?.name.toLowerCase().includes(searchTerm);
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No projects</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(p => {
                const partner = partners.find(pt => pt.id === p.partnerId);
                const worstStatus = getWorstStatus(p);
                const teamSize = p.teamMembers?.length || 0;
                
                return `
                    <tr>
                        <td><strong>${p.name}</strong></td>
                        <td>${partner?.name || 'Unknown'}</td>
                        <td>${p.phase || 'N/A'}</td>
                        <td>
                            <div class="progress-bar"><div class="progress-fill" style="width: ${p.progress || 0}%"></div></div>
                            ${p.progress || 0}%
                        </td>
                        <td>${p.cost ? (p.cost / 1000000).toFixed(2) : '0.00'}</td>
                        <td>${teamSize} members</td>
                        <td>
                            <div class="status-dot status-${worstStatus.toLowerCase()}" style="width: 16px; height: 16px; display: inline-block;"></div>
                            ${worstStatus}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="openProjectModal('${p.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteProject('${p.id}')">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterProjectsTable() { updateProjectsManageTable(); }

        function openProjectModal(projectId = null) {
            editMode = !!projectId;
            currentProject = projectId ? projects.find(p => p.id === projectId) : null;
            document.getElementById('projectModalTitle').textContent = editMode ? 'Edit Project' : 'Add Project';

            const p = currentProject || { teamMembers: [] };
            const modalBody = document.getElementById('projectModalBody');

            const sortedMembers = [...members].sort((a, b) => `${a.firstName} ${a.lastName}`.localeCompare(`${b.firstName} ${b.lastName}`));
            const sortedRoles = [...roles].sort((a, b) => a.name.localeCompare(b.name));
            
            modalBody.innerHTML = `
                <form id="projectForm">
                    <div class="section-title">üìã Project Information</div>
                    <div class="form-group">
                        <label class="form-label">Project Name *</label>
                        <input type="text" class="form-input" id="projectName" value="${p.name || ''}" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Partner *</label>
                            <select class="form-input" id="projectPartner" required>
                                <option value="">Select Partner</option>
                                ${[...partners].sort((a,b) => a.name.localeCompare(b.name)).map(pt => 
                                    `<option value="${pt.id}" ${p.partnerId === pt.id ? 'selected' : ''}>${pt.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phase *</label>
                            <select class="form-input" id="projectPhase" required>
                                ${PHASES.map(phase => `<option value="${phase}" ${p.phase === phase ? 'selected' : ''}>${phase}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Scope *</label>
                        <textarea class="form-input" id="projectScope" required>${p.scope || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expectation</label>
                        <textarea class="form-input" id="projectExpectation">${p.expectation || ''}</textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="projectStartTime" value="${p.startTime || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="projectEndTime" value="${p.endTime || ''}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cost (‡∏ø)</label>
                            <input type="number" class="form-input" id="projectCost" value="${p.cost || 0}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Progress (%)</label>
                            <input type="number" class="form-input" id="projectProgress" min="0" max="100" value="${p.progress || 0}">
                        </div>
                    </div>

                    <hr class="section-divider">
                    <div class="section-title">üë• Team Members with FTE Allocation</div>
                    <div style="overflow-x: auto; margin-bottom: 1rem;">
                        <div class="fte-grid">
                            <div class="fte-grid-header">Member</div>
                            <div class="fte-grid-header">Role</div>
                            ${MONTHS.map(m => `<div class="fte-grid-header">${m}</div>`).join('')}
                            <div class="fte-grid-header">Action</div>
                        </div>
                        <div id="teamMembersList">
                            ${(p.teamMembers || []).map((tm, idx) => createTeamMemberRow(tm, idx, sortedMembers, sortedRoles)).join('')}
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addTeamMember()">+ Add Team Member</button>

                    <hr class="section-divider">
                    <div class="section-title">üìä Status Dimensions</div>
                    <div class="status-grid">
                        ${STATUS_DIMENSIONS.map(d => `
                            <div class="status-select-group">
                                <label style="font-size: 0.875rem;">${DIMENSION_LABELS[d]}</label>
                                <select class="form-input" id="${d}">
                                    <option value="Green" ${p[d] === 'Green' ? 'selected' : ''}>Green</option>
                                    <option value="Yellow" ${p[d] === 'Yellow' ? 'selected' : ''}>Yellow</option>
                                    <option value="Red" ${p[d] === 'Red' ? 'selected' : ''}>Red</option>
                                </select>
                            </div>
                        `).join('')}
                    </div>

                    <hr class="section-divider">
                    <div class="section-title">üéØ KPIs</div>
                    <div class="kpi-list" id="kpiList">
                        ${(p.kpis || []).map((kpi, idx) => `
                            <div class="kpi-item">
                                <div><label style="font-size: 0.75rem;">Name</label><input type="text" class="form-input kpi-name" value="${kpi.name || ''}"></div>
                                <div><label style="font-size: 0.75rem;">Target</label><input type="text" class="form-input kpi-target" value="${kpi.target || ''}"></div>
                                <div><label style="font-size: 0.75rem;">Current</label><input type="text" class="form-input kpi-current" value="${kpi.current || ''}"></div>
                                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">‚úï</button>
                            </div>
                        `).join('')}
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addKPI()">+ Add KPI</button>
                </form>
            `;

            document.getElementById('projectModal').classList.add('show');
        }

        function createTeamMemberRow(tm, idx, sortedMembers, sortedRoles) {
            const fteAllocation = tm.fteAllocation || [0,0,0,0,0,0,0,0,0,0,0,0];
            return `
                <div class="fte-grid">
                    <select class="form-input team-member-select" data-index="${idx}">
                        <option value="">Select Member</option>
                        ${sortedMembers.map(m => 
                            `<option value="${m.id}" ${tm.memberId === m.id ? 'selected' : ''}>${m.firstName} ${m.lastName}</option>`
                        ).join('')}
                    </select>
                    <select class="form-input team-role-select" data-index="${idx}">
                        <option value="">Select Role</option>
                        ${sortedRoles.map(r => 
                            `<option value="${r.id}" ${tm.roleId === r.id ? 'selected' : ''}>${r.name}</option>`
                        ).join('')}
                    </select>
                    ${fteAllocation.map((fte, mIdx) => 
                        `<input type="number" class="form-input fte-input team-fte" value="${fte}" step="0.01" min="0" max="2" data-index="${idx}" data-month="${mIdx}">`
                    ).join('')}
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeTeamMember(${idx})">‚úï</button>
                </div>
            `;
        }

        function addTeamMember() {
            const list = document.getElementById('teamMembersList');
            const idx = list.children.length;
            const sortedMembers = [...members].sort((a, b) => `${a.firstName} ${a.lastName}`.localeCompare(`${b.firstName} ${b.lastName}`));
            const sortedRoles = [...roles].sort((a, b) => a.name.localeCompare(b.name));
            list.insertAdjacentHTML('beforeend', createTeamMemberRow({}, idx, sortedMembers, sortedRoles));
        }

        function removeTeamMember(idx) {
            const items = document.getElementById('teamMembersList').children;
            if (items[idx]) items[idx].remove();
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('show');
            currentProject = null;
            editMode = false;
        }

        function addKPI() {
            document.getElementById('kpiList').insertAdjacentHTML('beforeend', `
                <div class="kpi-item">
                    <div><label style="font-size: 0.75rem;">Name</label><input type="text" class="form-input kpi-name"></div>
                    <div><label style="font-size: 0.75rem;">Target</label><input type="text" class="form-input kpi-target"></div>
                    <div><label style="font-size: 0.75rem;">Current</label><input type="text" class="form-input kpi-current"></div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">‚úï</button>
                </div>
            `);
        }

        async function saveProject() {
            const form = document.getElementById('projectForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Collect KPIs
            const kpis = [];
            document.querySelectorAll('.kpi-name').forEach((el, i) => {
                if (el.value) {
                    kpis.push({
                        name: el.value,
                        target: document.querySelectorAll('.kpi-target')[i].value,
                        current: document.querySelectorAll('.kpi-current')[i].value
                    });
                }
            });

            // Collect Team Members
            const teamMembers = [];
            const memberSelects = document.querySelectorAll('.team-member-select');
            const roleSelects = document.querySelectorAll('.team-role-select');

            memberSelects.forEach((memberSelect, idx) => {
                const memberId = memberSelect.value;
                const roleId = roleSelects[idx]?.value;

                if (memberId && roleId) {
                    const fteAllocation = [];
                    for (let m = 0; m < 12; m++) {
                        const fteInput = document.querySelector(`.team-fte[data-index="${idx}"][data-month="${m}"]`);
                        fteAllocation.push(parseFloat(fteInput?.value || 0));
                    }

                    teamMembers.push({ memberId, roleId, fteAllocation });
                }
            });

            const projectData = {
                id: editMode && currentProject ? currentProject.id : 'proj' + Date.now(),
                partnerId: document.getElementById('projectPartner').value,
                name: document.getElementById('projectName').value,
                scope: document.getElementById('projectScope').value,
                expectation: document.getElementById('projectExpectation').value,
                startTime: document.getElementById('projectStartTime').value,
                endTime: document.getElementById('projectEndTime').value,
                cost: parseFloat(document.getElementById('projectCost').value) || 0,
                progress: parseInt(document.getElementById('projectProgress').value) || 0,
                phase: document.getElementById('projectPhase').value,
                teamMembers: teamMembers,
                kpis: kpis
            };

            STATUS_DIMENSIONS.forEach(d => projectData[d] = document.getElementById(d).value);

            try {
                // Save to Supabase
                await saveProjectToSupabase(projectData);

                if (editMode && currentProject) {
                    const index = projects.findIndex(p => p.id === currentProject.id);
                    projects[index] = projectData;
                    showSuccess('Project updated!');
                } else {
                    projects.push(projectData);
                    showSuccess('Project added!');
                }

                closeProjectModal();
                updateProjectsManageTable();
                updateDashboard();
                updatePortfolio();
                updateResourceCharts();
            } catch (error) {
                showError('Failed to save project: ' + error.message);
                console.error('Save project error:', error);
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('Delete project?')) return;

            try {
                await deleteProjectFromSupabase(projectId);
                projects = projects.filter(p => p.id !== projectId);
                showSuccess('Project deleted!');
                updateProjectsManageTable();
                updateDashboard();
                updateResourceCharts();
            } catch (error) {
                showError('Failed to delete project: ' + error.message);
                console.error('Delete project error:', error);
            }
        }

        async function saveAllProjectsData() {
            await saveToFile(projects, 'projects.json', 'projects');
        }

        function uploadProjectsJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    projects = JSON.parse(e.target.result);
                    showSuccess('Projects uploaded!');
                    updateProjectsManageTable();
                    updateDashboard();
                    updateResourceCharts();
                } catch (error) {
                    showError('Parse error: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ========== MEMBER MANAGEMENT ==========
        function updateMemberTable() {
            const tbody = document.getElementById('membersTableBody');
            const searchTerm = document.getElementById('memberSearch')?.value.toLowerCase() || '';
            const filtered = members.filter(m => 
                m.firstName?.toLowerCase().includes(searchTerm) ||
                m.lastName?.toLowerCase().includes(searchTerm) ||
                m.email?.toLowerCase().includes(searchTerm) ||
                m.company?.toLowerCase().includes(searchTerm)
            );

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No members</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(m => {
                const roleBadges = (m.roles || []).map(rId => {
                    const role = roles.find(r => r.id === rId);
                    return role ? `<span class="role-badge" style="background: ${role.color}">${role.name}</span>` : '';
                }).join('');

                return `
                    <tr>
                        <td><strong>${m.firstName} ${m.lastName}</strong></td>
                        <td>${m.email}</td>
                        <td>${m.company || 'N/A'}</td>
                        <td>${m.department || 'N/A'}</td>
                        <td>${roleBadges || 'N/A'}</td>
                        <td>${m.phone || 'N/A'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="editMember('${m.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteMember('${m.id}')">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterMemberTable() { updateMemberTable(); }

        function openMemberModal(memberId = null) {
            editMode = !!memberId;
            currentMember = memberId ? members.find(m => m.id === memberId) : null;
            document.getElementById('memberModalTitle').textContent = editMode ? 'Edit Member' : 'Add Member';

            const m = currentMember || {};
            const modalBody = document.getElementById('memberModalBody');
            
            modalBody.innerHTML = `
                <form id="memberForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-input" id="memberFirstName" value="${m.firstName || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-input" id="memberLastName" value="${m.lastName || ''}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-input" id="memberEmail" value="${m.email || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-input" id="memberPhone" value="${m.phone || ''}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Company *</label>
                            <input type="text" class="form-input" id="memberCompany" value="${m.company || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-input" id="memberDepartment" value="${m.department || ''}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-input" id="memberTitle" value="${m.title || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-input" id="memberLocation" value="${m.location || ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Roles *</label>
                        <div class="category-checkbox-group" id="memberRoleCheckboxes"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Skills (comma-separated)</label>
                        <input type="text" class="form-input" id="memberSkills" value="${(m.skills || []).join(', ')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-input" id="memberNotes">${m.notes || ''}</textarea>
                    </div>
                </form>
            `;

            populateRoleCheckboxes(m.roles || []);
            document.getElementById('memberModal').classList.add('show');
        }

        function closeMemberModal() {
            document.getElementById('memberModal').classList.remove('show');
            currentMember = null;
            editMode = false;
        }

        function populateRoleCheckboxes(selected = []) {
            const container = document.getElementById('memberRoleCheckboxes');
            if (roles.length === 0) {
                container.innerHTML = '<p style="padding: 1rem;">No roles available</p>';
                return;
            }
            const sortedRoles = [...roles].sort((a, b) => a.name.localeCompare(b.name));
            container.innerHTML = sortedRoles.map(role => {
                const isChecked = selected.includes(role.id) || selected.includes(role.name);
                return `
                    <label class="category-checkbox-item">
                        <input type="checkbox" name="memberRole" value="${role.id}" ${isChecked ? 'checked' : ''}>
                        <div class="category-color-indicator" style="background: ${role.color}"></div>
                        <span>${role.name}</span>
                    </label>
                `;
            }).join('');
        }

        async function saveMember() {
            const form = document.getElementById('memberForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const selectedRoles = Array.from(document.querySelectorAll('input[name="memberRole"]:checked')).map(cb => cb.value);
            if (selectedRoles.length === 0) {
                showError('Select at least one role');
                return;
            }

            const skillsText = document.getElementById('memberSkills').value;
            const skills = skillsText ? skillsText.split(',').map(s => s.trim()).filter(s => s) : [];

            const memberData = {
                id: editMode && currentMember ? currentMember.id : 'm' + Date.now(),
                firstName: document.getElementById('memberFirstName').value,
                lastName: document.getElementById('memberLastName').value,
                email: document.getElementById('memberEmail').value,
                phone: document.getElementById('memberPhone').value,
                company: document.getElementById('memberCompany').value,
                department: document.getElementById('memberDepartment').value,
                title: document.getElementById('memberTitle').value,
                location: document.getElementById('memberLocation').value,
                roles: selectedRoles,
                skills: skills,
                notes: document.getElementById('memberNotes').value
            };

            try {
                // Save to Supabase
                await saveMemberToSupabase(memberData);

                if (editMode && currentMember) {
                    const index = members.findIndex(m => m.id === currentMember.id);
                    members[index] = memberData;
                    showSuccess('Member updated!');
                } else {
                    members.push(memberData);
                    showSuccess('Member added!');
                }

                closeMemberModal();
                updateMemberTable();
            } catch (error) {
                showError('Failed to save member: ' + error.message);
                console.error('Save member error:', error);
            }
        }

        function editMember(memberId) { openMemberModal(memberId); }

        async function deleteMember(memberId) {
            if (!confirm('Delete member?')) return;

            try {
                await deleteMemberFromSupabase(memberId);
                members = members.filter(m => m.id !== memberId);
                showSuccess('Member deleted!');
                updateMemberTable();
            } catch (error) {
                showError('Failed to delete member: ' + error.message);
                console.error('Delete member error:', error);
            }
        }

        async function saveAllMembers() {
            await saveToFile(members, 'members.json', 'members');
        }

        function uploadMembersJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    members = JSON.parse(e.target.result);
                    showSuccess('Members uploaded!');
                    updateMemberTable();
                } catch (error) {
                    showError('Parse error: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ========== ROLE MANAGEMENT ==========
        function updateRoleList() {
            const container = document.getElementById('roleList');
            if (roles.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üëî</div><p>No roles</p></div>';
                return;
            }

            container.innerHTML = roles.map(role => `
                <div class="role-item">
                    <input type="color" class="role-color-picker" value="${role.color}" onchange="updateRoleColor('${role.id}', this.value)">
                    <div style="flex: 1;">
                        <input type="text" class="form-input" value="${role.name}" onchange="updateRoleName('${role.id}', this.value)" placeholder="Role name" style="margin-bottom: 0.5rem;">
                        <input type="text" class="form-input" value="${role.description || ''}" onchange="updateRoleDescription('${role.id}', this.value)" placeholder="Description" style="font-size: 0.875rem;">
                    </div>
                    <div style="min-width: 120px; text-align: center; padding: 0.5rem; background: ${role.color}; color: white; border-radius: 0.5rem; font-weight: 500;">${role.name}</div>
                    <button class="btn btn-danger btn-sm" onclick="deleteRole('${role.id}')">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        async function addNewRole() {
            const newRole = {
                id: 'role_' + Date.now(),
                name: 'New Role',
                color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0'),
                description: ''
            };

            try {
                await saveRoleToSupabase(newRole);
                roles.push(newRole);
                updateRoleList();
                showSuccess('Role added!');
            } catch (error) {
                showError('Failed to add role: ' + error.message);
                console.error('Add role error:', error);
            }
        }

        async function updateRoleColor(roleId, color) {
            const role = roles.find(r => r.id === roleId);
            if (role) {
                role.color = color;
                try {
                    await saveRoleToSupabase(role);
                    updateRoleList();
                    updateMemberTable();
                } catch (error) {
                    showError('Failed to update role: ' + error.message);
                }
            }
        }

        async function updateRoleName(roleId, name) {
            const role = roles.find(r => r.id === roleId);
            if (role && name.trim()) {
                role.name = name;
                try {
                    await saveRoleToSupabase(role);
                } catch (error) {
                    showError('Failed to update role: ' + error.message);
                }
            } else {
                showError('Name required');
                updateRoleList();
            }
        }

        async function updateRoleDescription(roleId, desc) {
            const role = roles.find(r => r.id === roleId);
            if (role) {
                role.description = desc;
                try {
                    await saveRoleToSupabase(role);
                } catch (error) {
                    showError('Failed to update role: ' + error.message);
                }
            }
        }

        async function deleteRole(roleId) {
            if (!confirm('Delete role?')) return;

            try {
                await deleteRoleFromSupabase(roleId);
                // Update members that have this role
                for (const m of members) {
                    if (m.roles && m.roles.includes(roleId)) {
                        m.roles = m.roles.filter(r => r !== roleId);
                        await saveMemberToSupabase(m);
                    }
                }
                roles = roles.filter(r => r.id !== roleId);
                updateRoleList();
                updateMemberTable();
                showSuccess('Role deleted!');
            } catch (error) {
                showError('Failed to delete role: ' + error.message);
                console.error('Delete role error:', error);
            }
        }

        async function saveAllRoles() {
            await saveToFile(roles, 'roles.json', 'roles');
        }

        function uploadRolesJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    roles = JSON.parse(e.target.result);
                    showSuccess('Roles uploaded!');
                    updateRoleList();
                    updateMemberTable();
                } catch (error) {
                    showError('Parse error: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ========== CATEGORY MANAGEMENT ==========
        function updateCategoryList() {
            const container = document.getElementById('categoryList');
            if (categories.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÅ</div><p>No categories</p></div>';
                return;
            }

            container.innerHTML = categories.map(cat => `
                <div class="category-item">
                    <input type="color" class="category-color-picker" value="${cat.color}" onchange="updateCategoryColor('${cat.id}', this.value)">
                    <div style="flex: 1;">
                        <input type="text" class="form-input" value="${cat.name}" onchange="updateCategoryName('${cat.id}', this.value)" placeholder="Category name">
                    </div>
                    <div style="min-width: 120px; text-align: center; padding: 0.5rem; background: ${cat.color}; color: white; border-radius: 0.5rem; font-weight: 500;">Preview</div>
                    <button class="btn btn-danger btn-sm" onclick="deleteCategory('${cat.id}')">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        async function addNewCategory() {
            const newCategory = {
                id: 'cat_' + Date.now(),
                name: 'New Category',
                color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')
            };

            try {
                await saveCategoryToSupabase(newCategory);
                categories.push(newCategory);
                updateCategoryList();
                showSuccess('Category added!');
            } catch (error) {
                showError('Failed to add category: ' + error.message);
                console.error('Add category error:', error);
            }
        }

        async function updateCategoryColor(catId, color) {
            const cat = categories.find(c => c.id === catId);
            if (cat) {
                cat.color = color;
                try {
                    await saveCategoryToSupabase(cat);
                    updateCategoryList();
                    updateMapMarkers();
                    updatePartnerTable();
                } catch (error) {
                    showError('Failed to update category: ' + error.message);
                }
            }
        }

        async function updateCategoryName(catId, name) {
            const cat = categories.find(c => c.id === catId);
            if (cat && name.trim()) {
                cat.name = name;
                try {
                    await saveCategoryToSupabase(cat);
                } catch (error) {
                    showError('Failed to update category: ' + error.message);
                }
            } else {
                showError('Name required');
                updateCategoryList();
            }
        }

        async function deleteCategory(catId) {
            if (!confirm('Delete category?')) return;

            try {
                await deleteCategoryFromSupabase(catId);
                // Update partners that have this category
                for (const p of partners) {
                    if (p.categories && p.categories.includes(catId)) {
                        p.categories = p.categories.filter(c => c !== catId);
                        await savePartnerToSupabase(p);
                    }
                }
                categories = categories.filter(c => c.id !== catId);
                updateCategoryList();
                updatePartnerTable();
                populateFilters();
                showSuccess('Category deleted!');
            } catch (error) {
                showError('Failed to delete category: ' + error.message);
                console.error('Delete category error:', error);
            }
        }

        async function saveAllCategories() {
            await saveToFile(categories, 'categories.json', 'categories');
        }

        function uploadCategoriesJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    categories = JSON.parse(e.target.result);
                    showSuccess('Categories uploaded!');
                    updateCategoryList();
                    populateFilters();
                    updatePartnerTable();
                } catch (error) {
                    showError('Parse error: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ========== RESOURCES & CHARTS ==========
        function initializeCharts() {
            updateHeatmap();
            updateRoleWorkloadChart();
            populateRoleFilter();
            populateMemberFilter();
        }

        function updateResourceCharts() {
            updateHeatmap();
            updateRoleWorkloadChart();
            updateRoleSpecificChart();
            updateMemberWorkloadChart();
        }

        function updateHeatmap() {
            const maxFTE = parseFloat(document.getElementById('maxFTE')?.value || 1.5);
            const roleWorkload = {};

            roles.forEach(role => {
                roleWorkload[role.id] = { name: role.name, months: [0,0,0,0,0,0,0,0,0,0,0,0] };
            });

            projects.forEach(project => {
                (project.teamMembers || []).forEach(tm => {
                    if (tm.roleId && roleWorkload[tm.roleId]) {
                        (tm.fteAllocation || []).forEach((fte, idx) => {
                            roleWorkload[tm.roleId].months[idx] += fte;
                        });
                    }
                });
            });

            const container = document.getElementById('heatmapContainer');
            let html = '<table class="heatmap-table"><thead><tr><th>Role</th>';
            MONTHS.forEach(m => html += `<th>${m}</th>`);
            html += '</tr></thead><tbody>';

            Object.values(roleWorkload).forEach(rw => {
                html += `<tr><td><strong>${rw.name}</strong></td>`;
                rw.months.forEach(fte => {
                    const ratio = Math.min(fte / maxFTE, 1);
                    const intensity = Math.floor(ratio * 255);
                    /*const color = fte === 0 ? '#ffffff' : `rgb(${intensity}, ${0}, ${255-intensity})`; */ /*`rgb(${255-intensity}, ${200}, ${255-intensity})`;*/
                    let color = 'rgba(255, 255, 255, 0)';
                    
                    if (fte === 0) {
                        color = 'rgba(255, 255, 255, 0)';
                    } else if (fte <= maxFTE * 0.5) {
                        color = `rgba(34, 197, 94, ${0.3 + intensity * 0.3})`;
                    } else if (fte <= maxFTE) {
                        color = `rgba(234, 179, 8, ${0.4 + intensity * 0.4})`;
                    } else {
                        color = `rgba(239, 68, 68, ${0.6 + Math.min((fte - maxFTE) / maxFTE, 1) * 0.4})`;
                    }                    
                    
                    html += `<td class="heatmap-cell" style="background: ${color}; color: ${ratio > 0.6 ? 'white' : 'black'};" title="${fte.toFixed(2)} FTE">${fte.toFixed(2)}</td>`;
                    DIMENSION_LABELS
                    /*html += `<td class="heatmap-cell" style="background: ${color};" title="${fte.toFixed(2)} FTE">${fte > 0 ? fte.toFixed(1) : ''}</td>`;*/
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            html += `<div style="margin-top: 1rem; display: flex; align-items: center; gap: 1rem;">
                <span style="font-size: 0.875rem; font-weight: 600;">Legend:</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 30px; height: 20px; background: #ffffff; border: 1px solid var(--border-color);"></div>
                    <span style="font-size: 0.875rem;">0 FTE</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 30px; height: 20px; background: rgb(234, 179, 8);"></div>
                    <span style="font-size: 0.875rem;">${(maxFTE/2).toFixed(1)} FTE</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 30px; height: 20px; background: rgb(255, 0, 0);"></div>
                    <span style="font-size: 0.875rem;">${maxFTE.toFixed(1)}+ FTE</span>
                </div>
            </div>`;

            container.innerHTML = html;
        }

        function updateRoleWorkloadChart() {
            const ctx = document.getElementById('roleWorkloadChart');
            if (!ctx) return;

            const roleWorkload = {};
            roles.forEach(role => {
                roleWorkload[role.id] = { name: role.name, color: role.color, months: [0,0,0,0,0,0,0,0,0,0,0,0] };
            });

            projects.forEach(project => {
                (project.teamMembers || []).forEach(tm => {
                    if (tm.roleId && roleWorkload[tm.roleId]) {
                        (tm.fteAllocation || []).forEach((fte, idx) => {
                            roleWorkload[tm.roleId].months[idx] += fte;
                        });
                    }
                });
            });

            if (charts.roleWorkload) charts.roleWorkload.destroy();

            charts.roleWorkload = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: MONTHS,
                    datasets: Object.values(roleWorkload).map(rw => ({
                        label: rw.name,
                        data: rw.months,
                        borderColor: rw.color,
                        backgroundColor: rw.color + '33',
                        tension: 0.4
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Role Workload Trend (FTE)' },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'FTE' } }
                    }
                }
            });
        }

        function populateRoleFilter() {
            const select = document.getElementById('roleFilterChart');
            if (!select) return;
            const sortedRoles = [...roles].sort((a, b) => a.name.localeCompare(b.name));
            select.innerHTML = '<option value="">Select Role</option>' + 
                sortedRoles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
        }

        function populateMemberFilter() {
            const select = document.getElementById('memberFilterChart');
            if (!select) return;
            const sortedMembers = [...members].sort((a, b) => `${a.firstName} ${a.lastName}`.localeCompare(`${b.firstName} ${b.lastName}`));
            select.innerHTML = '<option value="">Select Member</option>' + 
                sortedMembers.map(m => `<option value="${m.id}">${m.firstName} ${m.lastName}</option>`).join('');
        }

        function updateRoleSpecificChart() {
            const roleId = document.getElementById('roleFilterChart')?.value;
            if (!roleId) return;

            const role = roles.find(r => r.id === roleId);
            if (!role) return;

            const memberWorkload = {};
            const totalFTE = [0,0,0,0,0,0,0,0,0,0,0,0];

            projects.forEach(project => {
                (project.teamMembers || []).forEach(tm => {
                    if (tm.roleId === roleId) {
                        const member = members.find(m => m.id === tm.memberId);
                        const memberName = member ? `${member.firstName} ${member.lastName}` : 'Unknown';
                        
                        if (!memberWorkload[tm.memberId]) {
                            memberWorkload[tm.memberId] = { name: memberName, months: [0,0,0,0,0,0,0,0,0,0,0,0] };
                        }
                        
                        (tm.fteAllocation || []).forEach((fte, idx) => {
                            memberWorkload[tm.memberId].months[idx] += fte;
                            totalFTE[idx] += fte;
                        });
                    }
                });
            });

            const ctx = document.getElementById('roleSpecificChart');
            if (charts.roleSpecific) charts.roleSpecific.destroy();

            const datasets = [
                {
                    type: 'line',
                    label: 'Total FTE',
                    data: totalFTE,
                    borderColor: role.color,
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    yAxisID: 'y'
                }
            ];

            Object.values(memberWorkload).forEach((mw, idx) => {
                datasets.push({
                    type: 'bar',
                    label: mw.name,
                    data: mw.months,
                    backgroundColor: role.color + Math.floor(80 + idx * 20).toString(16),
                    yAxisID: 'y'
                });
            });

            charts.roleSpecific = new Chart(ctx, {
                type: 'bar',
                data: { labels: MONTHS, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: `${role.name} - Workload Distribution` },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'FTE' } }
                    }
                }
            });
        }

        function updateMemberWorkloadChart() {
            const memberId = document.getElementById('memberFilterChart')?.value;
            if (!memberId) return;

            const member = members.find(m => m.id === memberId);
            if (!member) return;

            const roleWorkload = {};
            const totalFTE = [0,0,0,0,0,0,0,0,0,0,0,0];

            projects.forEach(project => {
                (project.teamMembers || []).forEach(tm => {
                    if (tm.memberId === memberId) {
                        const role = roles.find(r => r.id === tm.roleId);
                        const roleName = role?.name || 'Unknown';
                        
                        if (!roleWorkload[tm.roleId]) {
                            roleWorkload[tm.roleId] = { name: roleName, color: role?.color || '#64748b', months: [0,0,0,0,0,0,0,0,0,0,0,0] };
                        }
                        
                        (tm.fteAllocation || []).forEach((fte, idx) => {
                            roleWorkload[tm.roleId].months[idx] += fte;
                            totalFTE[idx] += fte;
                        });
                    }
                });
            });

            const ctx = document.getElementById('memberWorkloadChart');
            if (charts.memberWorkload) charts.memberWorkload.destroy();

            const datasets = [
                {
                    type: 'line',
                    label: 'Total FTE',
                    data: totalFTE,
                    borderColor: '#2563eb',
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    yAxisID: 'y'
                }
            ];

            Object.values(roleWorkload).forEach(rw => {
                datasets.push({
                    type: 'bar',
                    label: rw.name,
                    data: rw.months,
                    backgroundColor: rw.color,
                    yAxisID: 'y'
                });
            });

            charts.memberWorkload = new Chart(ctx, {
                type: 'bar',
                data: { labels: MONTHS, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: `${member.firstName} ${member.lastName} - Workload by Role` },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'FTE' } }
                    }
                }
            });
        }

        // ========== CSV EXPORT ==========
        function exportProjectsCSV() {
            const headers = ['Project', 'Partner', 'Phase', 'Progress', 'Cost (‡∏ø)', 'Status'];
            const rows = projects.map(p => {
                const partner = partners.find(pt => pt.id === p.partnerId);
                return [
                    p.name,
                    partner?.name || 'Unknown',
                    p.phase || 'N/A',
                    p.progress || 0,
                    p.cost || 0,
                    getWorstStatus(p)
                ];
            });
            downloadCSV([headers, ...rows], 'projects.csv');
        }

        function exportPartnersCSV() {
            const headers = ['Name', 'Categories', 'City', 'Country', 'Agreement', 'Value (‡∏øM)', 'Expiry'];
            const rows = partners.map(p => [
                p.name,
                (p.categories || []).join('; '),
                p.location?.city || '',
                p.location?.country || '',
                p.agreementType || '',
                p.contractValue || '',
                p.expiryDate || ''
            ]);
            downloadCSV([headers, ...rows], 'partners.csv');
        }

        function exportMembersCSV() {
            const headers = ['First Name', 'Last Name', 'Email', 'Company', 'Department', 'Roles'];
            const rows = members.map(m => [
                m.firstName,
                m.lastName,
                m.email,
                m.company || '',
                m.department || '',
                (m.roles || []).map(rId => roles.find(r => r.id === rId)?.name || rId).join('; ')
            ]);
            downloadCSV([headers, ...rows], 'members.csv');
        }

        function exportRolesCSV() {
            const headers = ['Name', 'Color', 'Description'];
            const rows = roles.map(r => [r.name, r.color, r.description || '']);
            downloadCSV([headers, ...rows], 'roles.csv');
        }

        function exportCategoriesCSV() {
            const headers = ['Name', 'Color'];
            const rows = categories.map(c => [c.name, c.color]);
            downloadCSV([headers, ...rows], 'categories.csv');
        }

        function downloadCSV(data, filename) {
            const csv = data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
            showSuccess('CSV exported!');
        }

        // ========== FILTERS ==========
        function populateFilters() {
            const sortedCategories = [...categories].sort((a, b) => a.name.localeCompare(b.name));
            const sortedPartners = [...partners].sort((a, b) => a.name.localeCompare(b.name));
            
            ['mapCategoryFilter', 'dashboardCategoryFilter', 'portfolioCategoryFilter'].forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                while (select.options.length > 1) select.remove(1);
                sortedCategories.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });
            });

            ['dashboardPartnerFilter', 'portfolioPartnerFilter'].forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                while (select.options.length > 1) select.remove(1);
                sortedPartners.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.name;
                    select.appendChild(opt);
                });
            });

            const phaseSelect = document.getElementById('dashboardPhaseFilter');
            if (phaseSelect) {
                while (phaseSelect.options.length > 1) phaseSelect.remove(1);
                PHASES.forEach(phase => {
                    const opt = document.createElement('option');
                    opt.value = phase;
                    opt.textContent = phase;
                    phaseSelect.appendChild(opt);
                });
            }
        }

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
